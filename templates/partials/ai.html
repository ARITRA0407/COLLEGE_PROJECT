<!-- templates/partials/ai.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>edVance CSV Chatbot (AI Partial)</title>

  <style>
    /* Scoped styles: everything lives under .edv-ai-root to avoid collisions */
    .edv-ai-root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:12px; display:block; box-sizing:border-box; }

    /* Chat container (not full viewport to avoid interfering when included) */
    .edv-ai-chat-wrap {
      margin: 0 auto;
      width: 100%;
      max-width: 100%;
      height: 600px; /* default height; tweaked by page-level media queries in index.html */
      border:1px solid #ddd;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      background: #ffffff;
      box-shadow: 0 6px 18px rgba(2,6,23,0.04);
      box-sizing: border-box;
    }

    .edv-ai-messages {
      padding:16px;
      flex:1;
      overflow:auto;
      background:#fbfbfb;
    }

    .edv-ai-inputbar {
      display:flex;
      gap:8px;
      padding:12px;
      border-top:1px solid #eee;
      background:white;
      align-items:center;
      box-sizing:border-box;
    }

    /* IMPORTANT: allow input to shrink in flexbox (avoids overflow in narrow containers) */
    .edv-ai-input {
      flex:1 1 auto;
      min-width: 0;            /* <-- prevents flex children from forcing overflow */
      padding:10px 12px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:15px;
      box-sizing:border-box;
      height:44px;             /* more comfortable input height */
      line-height:20px;
    }

    /* Make Send button a stable size (doesn't stretch) and match input height */
    .edv-ai-send-btn {
      flex: 0 0 140px;        /* fixed width, won't stretch */
      width: 140px;
      height:44px;
      padding:0 14px;
      border-radius:6px;
      border:none;
      background:#0b76ef;
      color:white;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
    }

    .edv-ai-msg { margin-bottom:12px; display:block; }
    .edv-ai-msg-user { text-align:right; }

    .edv-ai-bubble {
      display:inline-block;
      padding:10px 12px;
      border-radius:10px;
      max-width:80%;
      box-sizing:border-box;
      word-break:break-word;
      white-space:pre-wrap;
    }

    .edv-ai-bubble-user { background:#d5f0ff; }
    .edv-ai-bubble-bot {
      background:#f1f3f5;
      text-align:left;
      font-family:monospace;
      font-size:13px;
      color:#0b1720;
    }

    .edv-ai-meta { color:#666; font-size:12px; margin-top:4px; }

    /* Sources dropdown */
    .edv-ai-sources summary {
      cursor: pointer;
      color: #0b76ef;
      font-weight: 600;
      font-size: 12px;
      margin-top: 6px;
    }
    .edv-ai-sources pre {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 4px;
    }

    /* small screens */
    @media (max-width:720px) {
      .edv-ai-chat-wrap { height:520px; width:100%; padding:8px; }
      .edv-ai-bubble { font-size:14px; }
      .edv-ai-send-btn { flex: 0 0 110px; width:110px; height:40px; }
      .edv-ai-input { height:40px; font-size:14px; }
    }
  </style>
</head>
<body>
  <!-- Root wrapper (scoped) -->
  <div class="edv-ai-root" role="region" aria-label="edvance CSV chatbot partial">
    <div class="edv-ai-chat-wrap" role="application" aria-label="CSV chatbot">
      <div class="edv-ai-messages" id="edv-ai-messages" aria-live="polite" aria-atomic="false"></div>

      <div class="edv-ai-inputbar">
        <input id="edv-ai-query" class="edv-ai-input" type="text"
               placeholder="Ask about colleges, rankings, placements or reviews â€” answers come only from CSVs" aria-label="Ask a question"/>
        <button id="edv-ai-send" class="edv-ai-send-btn" aria-label="Send question">Send</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const messagesEl = document.getElementById('edv-ai-messages');
      const input = document.getElementById('edv-ai-query');
      const btn = document.getElementById('edv-ai-send');

      function appendMessage(text, who='bot', meta='') {
        const wrap = document.createElement('div');
        wrap.className = 'edv-ai-msg' + (who === 'user' ? ' edv-ai-msg-user' : '');

        const bubble = document.createElement('div');
        bubble.className = 'edv-ai-bubble ' + (who === 'user' ? 'edv-ai-bubble-user' : 'edv-ai-bubble-bot');
        bubble.textContent = text;

        wrap.appendChild(bubble);

        if (meta) {
          const metaEl = document.createElement('div');
          metaEl.className = 'edv-ai-meta';

          // NEW: sources dropdown
          try {
            const parsed = JSON.parse(meta);
            const details = document.createElement('details');
            details.className = 'edv-ai-sources';
            const summary = document.createElement('summary');
            summary.textContent = 'Sources';
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(parsed, null, 2);
            details.appendChild(summary);
            details.appendChild(pre);
            metaEl.appendChild(details);
          } catch(e) {
            metaEl.textContent = meta;
          }

          wrap.appendChild(metaEl);
        }

        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendQuery() {
        const q = input.value.trim();
        if (!q) return;
        appendMessage(q, 'user');
        input.value = '';
        appendMessage('Thinking...', 'bot');

        try {
          const res = await fetch('/ai/chat', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({query: q})
          });

          // attempt to parse JSON safely
          let data;
          try {
            data = await res.json();
          } catch (e) {
            throw new Error('Server did not return JSON');
          }

          // remove the 'Thinking...' message (the last bot bubble)
          const botBubbles = messagesEl.querySelectorAll('.edv-ai-msg .edv-ai-bubble.edv-ai-bubble-bot');
          if (botBubbles.length) {
            const lastBubble = botBubbles[botBubbles.length - 1];
            if (lastBubble && lastBubble.textContent === 'Thinking...') {
              lastBubble.parentElement.remove();
            }
          }

          if (data.ok) {
            appendMessage(data.answer, 'bot', JSON.stringify(data.sources));
          } else {
            appendMessage(data.answer || 'No answer available', 'bot');
          }
        } catch (e) {
          // remove the 'Thinking...' message if present
          const botBubbles = messagesEl.querySelectorAll('.edv-ai-msg .edv-ai-bubble.edv-ai-bubble-bot');
          if (botBubbles.length) {
            const lastBubble = botBubbles[botBubbles.length - 1];
            if (lastBubble && lastBubble.textContent === 'Thinking...') {
              lastBubble.parentElement.remove();
            }
          }
          appendMessage('Error contacting server: ' + (e.message || String(e)), 'bot');
        }
      }

      btn.addEventListener('click', sendQuery);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendQuery(); });

      // optional: small accessibility helper to focus input when the partial loads
      try { document.getElementById('edv-ai-query').focus(); } catch (_) {}
    })();
  </script>
</body>
</html>
